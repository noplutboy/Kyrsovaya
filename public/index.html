<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>CRM: –ö—É–¥–∞–±–∞–µ–≤ –°–∞–±–∏—Ç</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* –°–¢–ò–õ–ò –û–°–¢–ê–õ–ò–°–¨ –¢–ï –ñ–ï, –ù–û –Ø –ò–• –ü–û–í–¢–û–†–Æ –ß–¢–û–ë–´ –¢–´ –ü–†–û–°–¢–û –°–ö–û–ü–ò–†–û–í–ê–õ –í–ï–°–¨ –§–ê–ô–õ */
        
         :root {
            --primary: #4f46e5;
            --dark: #1e293b;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background-color: #f1f5f9;
            color: #334155;
        }
        
        .hidden {
            display: none !important;
        }
        
        .author-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            font-size: 14px;
            color: #333;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid #4f46e5;
        }
        
        .login-wrapper {
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
            background: var(--bg-gradient);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        input,
        select {
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            outline: none;
        }
        
        button {
            padding: 12px;
            width: 100%;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .dashboard-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: var(--dark);
            color: white;
            padding: 25px;
            display: flex;
            flex-direction: column;
        }
        
        .menu-item {
            padding: 15px;
            cursor: pointer;
            border-radius: 10px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.3s;
        }
        
        .menu-item:hover,
        .menu-item.active {
            background: var(--primary);
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        .stats-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            flex: 1;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-val {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .tools-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            margin: 0;
            padding-left: 35px;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 14px;
            color: #94a3b8;
        }
        
        .btn-add {
            background: #10b981;
            width: auto;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-add:hover {
            background: #059669;
        }
        
        .btn-del {
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .table-wrap {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            padding: 15px;
            text-align: left;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-New {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-Paid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: white;
            color: #64748b;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transition: 0.2s;
        }
        
        .tab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: #e0e7ff;
        }
        
        .client-profile-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        .avatar-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            font-weight: bold;
        }
        
        .btn-buy {
            background: #4f46e5;
            color: white;
            width: auto;
            padding: 8px 20px;
        }
    </style>
</head>

<body>

    <div class="author-badge"><i class="fas fa-code"></i><span>–ö—É–¥–∞–±–∞–µ–≤ –°–∞–±–∏—Ç | –ê–¥–º–∏–Ω-32</span></div>

    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <h2 style="margin:0 0 20px 0;">–°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            <select id="role-select" onchange="toggleLoginMode()">
                <option value="admin">üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                <option value="client">üë§ –ö–ª–∏–µ–Ω—Ç</option>
            </select>
            <div id="client-select-wrapper" class="hidden">
                <select id="customer-select"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
            </div>
            <input type="password" id="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="admin-panel" class="dashboard-container hidden">
        <div class="sidebar">
            <h2><i class="fas fa-cubes"></i> CRM Pro</h2>
            <div class="menu-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i> –û–±–∑–æ—Ä</div>
            <div class="menu-item" onclick="switchTab('clients', this)"><i class="fas fa-users"></i> –ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="menu-item" onclick="switchTab('products', this)"><i class="fas fa-boxes"></i> –°–∫–ª–∞–¥</div>
            <div class="menu-item" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> –ó–∞–∫–∞–∑—ã</div>
            <div style="margin-top: auto;">
                <div class="menu-item" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5;" onclick="location.reload()">–í—ã—Ö–æ–¥</div>
            </div>
        </div>
        <div class="main-content">
            <div id="view-dashboard">
                <h1>üëã –ü—Ä–∏–≤–µ—Ç, –°–∞–±–∏—Ç!</h1>
                <div class="stats-grid">
                    <div class="stat-card" style="border-color: #3b82f6;">
                        <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                        <div class="stat-val" id="stat-clients">-</div>
                    </div>
                    <div class="stat-card" style="border-color: #f59e0b;">
                        <div class="stat-label">–ó–∞–∫–∞–∑—ã</div>
                        <div class="stat-val" id="stat-orders">-</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="stat-label">–í—ã—Ä—É—á–∫–∞</div>
                        <div class="stat-val" id="stat-revenue" style="color:#10b981">-</div>
                    </div>
                    <div class="stat-card" style="border-color: #8b5cf6;">
                        <div class="stat-label">–•–∏—Ç –ø—Ä–æ–¥–∞–∂</div>
                        <div class="stat-val" id="stat-top-product" style="font-size:20px; margin-top:15px">-</div>
                    </div>
                </div>
                <div style="display:flex; gap:20px;">
                    <div style="background:white; padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.05); flex:1;">
                        <h3 style="margin-top:0">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤</h3>
                        <div style="height: 250px; display:flex; justify-content:center;"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div style="background:white; padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.05); flex:1;">
                        <h3 style="margin-top:0">–¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü</h3>
                        <div style="background:#f1f5f9; height:20px; border-radius:10px; overflow:hidden; margin-top: 50px;">
                            <div style="width: 75%; background: linear-gradient(90deg, #4f46e5, #818cf8); height:100%;"></div>
                        </div>
                        <p style="text-align:right; font-size:14px; font-weight:bold; color:#64748b; margin-top:10px;">75% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                    </div>
                </div>
            </div>
            <div id="view-clients" class="hidden">
                <h1>üë• –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
                <div class="tools-bar">
                    <button class="btn-add" onclick="createCustomer()"><i class="fas fa-plus"></i> –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-clients" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('search-clients', 'clients-table-area')"></div>
                </div>
                <div class="table-wrap" id="clients-table-area">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div id="view-products" class="hidden">
                <h1>üîå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h1>
                <div class="tools-bar">
                    <button class="btn-add" onclick="createProduct()"><i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-products" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('search-products', 'products-table-area')"></div>
                </div>
                <div class="table-wrap" id="products-table-area">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div id="view-orders" class="hidden">
                <h1>üì¶ –í—Å–µ –∑–∞–∫–∞–∑—ã</h1>
                <div class="tools-bar">
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-orders" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('search-orders', 'orders-table-area')"></div>
                </div>
                <div class="table-wrap" id="orders-table-area">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div id="client-panel" class="dashboard-container hidden" style="flex-direction: column; background: #f8fafc;">
        <div style="background: white; padding: 15px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight:bold; font-size:20px; color: var(--primary);"><i class="fas fa-store"></i> MyStore</div>
            <button style="background:#ef4444; width:auto; padding:8px 15px; color:white; border-radius:5px; border:none; cursor:pointer;" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="main-content" style="max-width: 1000px; margin: 0 auto; width: 100%;">
            <div class="client-profile-header">
                <div class="avatar-circle" id="client-avatar">A</div>
                <div>
                    <h2 id="client-name-display" style="margin:0;">-</h2>
                    <p id="client-email-display" style="margin:5px 0; color:#64748b;">-</p><span class="badge status-New" style="background:#f1f5f9; color:#64748b;">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</span></div>
            </div>
            <div class="client-tabs">
                <div class="tab-btn active" onclick="switchClientTab('history', this)"><i class="fas fa-history"></i> –ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab-btn" onclick="switchClientTab('catalog', this)"><i class="fas fa-shopping-bag"></i> –ö–∞—Ç–∞–ª–æ–≥</div>
            </div>
            <div id="client-view-history">
                <div class="table-wrap" id="client-orders-area">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div id="client-view-catalog" class="hidden">
                <div class="tools-bar">
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-catalog" placeholder="–ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä..." onkeyup="filterTable('search-catalog', 'catalog-area')"></div>
                </div>
                <div class="table-wrap" id="catalog-area">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script>
        let currentClientId = null;

        window.onload = async function() {
            try {
                const res = await fetch('/api/auth/customers');
                const customers = await res.json();
                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è --</option>';
                customers.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.CustomerID;
                    opt.innerText = `${c.LastName} ${c.FirstName}`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
            }
        };

        function toggleLoginMode() {
            const role = document.getElementById('role-select').value;
            const clientSelect = document.getElementById('client-select-wrapper');
            role === 'admin' ? clientSelect.classList.add('hidden') : clientSelect.classList.remove('hidden');
        }

        async function handleLogin() {
            const role = document.getElementById('role-select').value;
            const pwd = document.getElementById('password-input').value;
            if (role === 'admin') {
                if (pwd !== '123') return alert('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞: 123');
                await initAdmin();
            } else {
                if (pwd !== '1234') return alert('–ü–∞—Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞: 1234');
                const select = document.getElementById('customer-select');
                if (!select.value) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è!');
                await initClient(select.value);
            }
        }

        async function initAdmin() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            const statsRes = await fetch('/api/admin/stats');
            const stats = await statsRes.json();
            document.getElementById('stat-clients').innerText = stats.ClientsCount;
            document.getElementById('stat-orders').innerText = stats.OrdersCount;
            document.getElementById('stat-revenue').innerText = (stats.TotalRevenue || 0).toLocaleString() + ' ‚Ç∏';
            document.getElementById('stat-top-product').innerText = stats.TopProduct || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            const ordersRes = await fetch('/api/admin/orders');
            const orders = await ordersRes.json();
            let newCount = orders.filter(o => o.Status === 'New').length;
            let completedCount = orders.filter(o => o.Status === 'Paid').length;
            const ctx = document.getElementById('salesChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ù–æ–≤—ã–µ', '–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ'],
                    datasets: [{
                        data: [newCount, completedCount],
                        backgroundColor: ['#3b82f6', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function switchTab(tab, btn) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            if (btn) btn.classList.add('active');
            ['dashboard', 'clients', 'products', 'orders'].forEach(t => document.getElementById('view-' + t).classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');

            if (tab === 'clients') {
                const res = await fetch('/api/admin/customers');
                const data = await res.json();
                renderTable(data, 'clients-table-area', ['ID', '–§–ò–û', '–ö–æ–Ω—Ç–∞–∫—Ç—ã', '–î–µ–π—Å—Ç–≤–∏–µ'], (row) => `<td>#${row.CustomerID}</td><td><b>${row.LastName} ${row.FirstName}</b></td><td>${row.Phone}<br><small>${row.Email}</small></td><td><a href="mailto:${row.Email}" class="badge status-New" style="text-decoration:none; background:#e0e7ff; color:#4338ca;">–ù–∞–ø–∏—Å–∞—Ç—å</a></td>`);
            } else if (tab === 'products') loadAdminProducts();
            else if (tab === 'orders') {
                const res = await fetch('/api/admin/orders');
                const data = await res.json();
                renderTable(data, 'orders-table-area', ['–ó–∞–∫–∞–∑', '–ö–ª–∏–µ–Ω—Ç', '–¢–æ–≤–∞—Ä—ã', '–°—É–º–º–∞', '–°—Ç–∞—Ç—É—Å'], (row) => `<td>#${row.OrderID}<br><small>${new Date(row.OrderDate).toLocaleDateString()}</small></td><td>${row.LastName} ${row.FirstName}</td><td style="max-width:250px;">${row.ProductList || '-'}</td><td><b>${(row.TotalAmount||0).toLocaleString()} ‚Ç∏</b></td><td><span class="badge status-${row.Status}">${row.Status}</span></td>`);
            }
        }

        async function loadAdminProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();
            renderTable(data, 'products-table-area', ['–¢–æ–≤–∞—Ä', '–¶–µ–Ω–∞', '–û—Å—Ç–∞—Ç–æ–∫', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'], (row) => `<td><b>${row.Name}</b></td><td>${row.Price} ‚Ç∏</td><td>${row.Stock} —à—Ç.</td><td><button class="btn-del" onclick="deleteProduct(${row.ProductID})"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</button></td>`);
        }

        async function createCustomer() {
            const fn = prompt("–ò–º—è:");
            if (!fn) return;
            const ln = prompt("–§–∞–º–∏–ª–∏—è:");
            const phone = prompt("–¢–µ–ª–µ—Ñ–æ–Ω:");
            const email = prompt("Email:");
            await fetch('/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName: fn,
                    lastName: ln,
                    email,
                    phone
                })
            });
            alert("–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
            switchTab('clients');
        }

        async function createProduct() {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
            if (!name) return;
            const price = prompt("–¶–µ–Ω–∞:");
            const stock = prompt("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:");
            await fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    price,
                    stock
                })
            });
            alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
            loadAdminProducts();
        }

        async function deleteProduct(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) return;
            const res = await fetch('/api/products/' + id, {
                method: 'DELETE'
            });
            const r = await res.json();
            if (r.error) alert(r.error);
            else {
                alert("–£–¥–∞–ª–µ–Ω–æ!");
                loadAdminProducts();
            }
        }

        async function initClient(id) {
            currentClientId = id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('client-panel').classList.remove('hidden');
            const infoRes = await fetch('/api/client/' + id + '/info');
            const info = await infoRes.json();
            document.getElementById('client-name-display').innerText = `${info.FirstName} ${info.LastName}`;
            document.getElementById('client-email-display').innerText = info.Email;
            document.getElementById('client-avatar').innerText = info.FirstName[0];
            loadClientOrders();
        }

        function switchClientTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (tabName === 'history') {
                document.getElementById('client-view-history').classList.remove('hidden');
                document.getElementById('client-view-catalog').classList.add('hidden');
                loadClientOrders();
            } else {
                document.getElementById('client-view-history').classList.add('hidden');
                document.getElementById('client-view-catalog').classList.remove('hidden');
                loadCatalog();
            }
        }

        async function loadClientOrders() {
            const res = await fetch('/api/client/' + currentClientId + '/orders');
            const data = await res.json();
            if (data.length === 0) document.getElementById('client-orders-area').innerHTML = '<p style="padding:20px; text-align:center;">–ü–æ–∫–∞ –ø–æ–∫—É–ø–æ–∫ –Ω–µ—Ç :(</p>';
            else {
                renderTable(data, 'client-orders-area', ['‚Ññ', '–î–∞—Ç–∞', '–¢–æ–≤–∞—Ä—ã', '–ò—Ç–æ–≥–æ', '–°—Ç–∞—Ç—É—Å'], (row) => `<td>#${row.OrderID}</td><td>${new Date(row.OrderDate).toLocaleDateString()}</td><td>${row.ProductList || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π'}</td><td><b>${(row.TotalAmount||0).toLocaleString()} ‚Ç∏</b></td><td><span class="badge status-${row.Status}">${row.Status}</span></td>`);
            }
        }

        async function loadCatalog() {
            const res = await fetch('/api/products');
            const data = await res.json();
            renderTable(data, 'catalog-area', ['–¢–æ–≤–∞—Ä', '–¶–µ–Ω–∞', '–ù–∞–ª–∏—á–∏–µ', '–î–µ–π—Å—Ç–≤–∏–µ'], (row) => `
                <td style="font-weight:bold; font-size:15px;">${row.Name}</td>
                <td style="color:#4f46e5; font-weight:bold;">${row.Price.toLocaleString()} ‚Ç∏</td>
                <td>${row.Stock > 0 ? '<span style="color:#10b981">–í –Ω–∞–ª–∏—á–∏–∏</span>' : '<span style="color:red">–ù–µ—Ç</span>'}</td>
                <td><button class="btn-buy" onclick="buyProduct(${row.ProductID}, ${row.Price}, '${row.Name}')"><i class="fas fa-shopping-cart"></i> –ö—É–ø–∏—Ç—å</button></td>
            `);
        }

        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ö–£–ü–ö–ò ---
        async function buyProduct(productId, price, name) {
            const method = prompt(`–ü–æ–∫—É–ø–∫–∞: ${name}\n–ö –æ–ø–ª–∞—Ç–µ: ${price} ‚Ç∏\n\n–í–≤–µ–¥–∏—Ç–µ –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (Kaspi, Card, Cash):`, "Kaspi");

            if (!method) return; // –ù–∞–∂–∞–ª –æ—Ç–º–µ–Ω–∞

            // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
            if (!['kaspi', 'card', 'cash'].includes(method.toLowerCase())) {
                return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã! –í–≤–µ–¥–∏—Ç–µ: Kaspi, Card –∏–ª–∏ Cash");
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const res = await fetch('/api/orders/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    customerId: currentClientId,
                    productId: productId,
                    price: price,
                    method: method
                })
            });

            const result = await res.json();
            if (result.error) {
                alert("–û—à–∏–±–∫–∞: " + result.error);
            } else {
                alert("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω —á–µ—Ä–µ–∑ " + method + "!\n–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ Paid.");
                switchClientTab('history', document.querySelector('.tab-btn')); // –ü–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            }
        }

        function renderTable(data, containerId, headers, rowRenderer) {
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            data.forEach(row => {
                html += '<tr>' + rowRenderer(row) + '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById(containerId).innerHTML = html;
        }

        function filterTable(inputId, tableId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(tableId).getElementsByTagName('table')[0];
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let text = tr[i].textContent || tr[i].innerText;
                tr[i].style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
            }
        }
    </script>
</body>

</html>